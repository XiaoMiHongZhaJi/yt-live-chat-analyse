<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=0.75, minimum-scale=0.5, maximum-scale=2.0, user-scalable=yes" />
    <title>弹幕统计分析</title>
    <link rel="stylesheet" href="../modules/layui/css/layui.css">
    <link rel="stylesheet" href="../css/public.css?t=2025_10_31">
    <script src="../modules/layui/layui.js"></script>
    <script src="../js/public.js?t=2025_10_31"></script>
    <script src="dialog/liveDetailEdit.js?t=2025_10_31"></script>
    <style>
        .tableBar a{
            margin: 2px;
        }
    </style>
</head>
<body>
<ul class="layui-nav layui-bg-cyan" lay-filter="demo">
    <li class="layui-nav-item"><a href="liveChat.html">弹幕列表</a></li>
    <li class="layui-nav-item"><a href="analyse.html">弹幕统计</a></li>
    <li class="layui-nav-item"><a href="srtInfo.html">字幕数据</a></li>
    <li class="layui-nav-item"><a href="liveInfo.html">数据管理</a></li>
    <li class="layui-nav-item layui-this"><a href="userManage.html">用户管理</a></li>
</ul>
<div class="layuimini-container layuimini-page-anim">
    <div class="layuimini-main">
        <table class="layui-hide" id="userInfo" lay-filter="currentTableFilter"></table>
    </div>
    <div class="layuimini-main">
        <fieldset class="table-search-fieldset">
            <legend>新增用户</legend>
            <form class="layui-form layui-form-pane" lay-filter="search-form" action="" method="post" enctype="multipart/form-data" role="form">
                <div class="layui-form-item">
                    <div class="layui-inline">
                        <label class="layui-form-label">用户名</label>
                        <div class="layui-input-inline">
                            <input type="text" name="userName" autocomplete="off" id="userName" class="layui-input" placeholder="用户名">
                        </div>
                    </div>
                    <div class="layui-inline">
                        <label class="layui-form-label" id="date-label">密码</label>
                        <div class="layui-input-inline">
                            <input type="text" name="password" autocomplete="off" id="password" class="layui-input" placeholder="非必填">
                        </div>
                    </div>
                    <div class="layui-inline">
                        <button class="layui-btn" id="submit" lay-submit lay-filter="add-btn">提交</button>
                    </div>
                </div>
            </form>
        </fieldset>
    </div>
</div>
<script type="text/html" id="currentTableBar">
    <div class="tableBar" style="padding-top: 5px;">
        <a lay-event="editUser" title="修改信息">
            <svg t="1653155523891" class="icon" viewBox="0 0 1069 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="6972" width="16" height="16"><path d="M746.027944 190.083832q-11.241517 0-18.906188-7.664671t-12.774451-17.884232-7.664671-20.9501-2.55489-17.884232l0-125.700599 2.043912 0q9.197605 0 17.373253 2.043912t19.928144 9.708583 28.61477 21.461078 42.411178 36.279441q27.592814 24.526946 43.944112 41.389222t25.037924 28.61477 10.730539 19.928144 2.043912 14.307385l0 16.351297-150.227545 0zM1063.856287 671.42515q3.065868 8.175649 4.087824 20.439122t-10.219561 23.50499q-5.10978 5.10978-9.197605 9.708583t-7.153693 7.664671q-4.087824 4.087824-7.153693 6.131737l-86.866267-85.844311q6.131737-5.10978 13.796407-12.263473t12.774451-11.241517q12.263473-11.241517 26.570858-9.708583t23.50499 6.642715q10.219561 5.10978 21.972056 17.884232t17.884232 27.081836zM703.105788 766.467066q22.483034 0 37.812375-12.263473l-198.259481 206.43513-282.05988 0q-19.417166 0-42.411178-11.241517t-42.922156-29.636727-33.213573-42.411178-13.285429-49.56487l0-695.952096q0-21.461078 9.708583-44.966068t26.570858-42.411178 38.323353-31.680639 44.966068-12.774451l391.409182 0 0 127.744511q0 19.417166 6.131737 41.9002t18.906188 41.389222 33.213573 31.680639 49.053892 12.774451l149.205589 0 0 338.267465-140.007984 145.117764q11.241517-16.351297 11.241517-35.768463 0-26.570858-18.906188-45.477046t-45.477046-18.906188l-383.233533 0q-26.570858 0-44.966068 18.906188t-18.39521 45.477046 18.39521 44.966068 44.966068 18.39521l383.233533 0zM319.872255 383.233533q-26.570858 0-44.966068 18.906188t-18.39521 45.477046 18.39521 44.966068 44.966068 18.39521l383.233533 0q26.570858 0 45.477046-18.39521t18.906188-44.966068-18.906188-45.477046-45.477046-18.906188l-383.233533 0zM705.149701 895.233533l13.285429-13.285429 25.548902-25.548902q15.329341-15.329341 33.724551-34.235529t36.790419-37.301397q43.944112-43.944112 99.129741-98.107784l85.844311 85.844311-99.129741 99.129741-36.790419 36.790419-33.724551 33.724551q-14.307385 14.307385-24.015968 24.526946t-10.730539 11.241517q-5.10978 4.087824-11.241517 8.686627t-12.263473 7.664671-18.906188 7.664671-26.05988 8.686627-25.548902 7.153693-18.39521 4.087824q-12.263473 2.043912-16.351297-3.065868t-2.043912-17.373253q1.021956-6.131737 4.087824-18.39521t7.153693-25.037924 7.664671-24.015968 5.620758-15.329341q6.131737-13.285429 16.351297-23.50499z" p-id="6973" fill="#515151"></path></svg>
        </a>
        <a lay-event="deleteUser" title="删除用户">
            <svg t="1653714580411" class="icon error" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="8262" width="16" height="16"><path d="M827.392 195.584q65.536 65.536 97.792 147.456t32.256 167.936-32.256 167.936-97.792 147.456-147.456 98.304-167.936 32.768-168.448-32.768-147.968-98.304-98.304-147.456-32.768-167.936 32.768-167.936 98.304-147.456 147.968-97.792 168.448-32.256 167.936 32.256 147.456 97.792zM720.896 715.776q21.504-21.504 18.944-49.152t-24.064-49.152l-107.52-107.52 107.52-107.52q21.504-21.504 24.064-49.152t-18.944-49.152-51.712-21.504-51.712 21.504l-107.52 106.496-104.448-104.448q-21.504-20.48-49.152-23.04t-49.152 17.92q-21.504 21.504-21.504 52.224t21.504 52.224l104.448 104.448-104.448 104.448q-21.504 21.504-21.504 51.712t21.504 51.712 49.152 18.944 49.152-24.064l104.448-104.448 107.52 107.52q21.504 21.504 51.712 21.504t51.712-21.504z" p-id="8263" fill="#d4237a"></path></svg>
        </a>
    </div>
</script>
<script>
    layui.use(['form', 'table', 'laydate', 'element'], function (){
        const $ = layui.jquery,
            form = layui.form,
            table = layui.table;
        const userStatus = ["禁用", "正常"]
        table.render({
            elem: '#userInfo',
            method:'post',
            cols: [[
                {field: 'id', width: 40, title: 'id', sort: true},
                {field: 'userId', title: '用户id', sort: true},
                {field: 'userName', title: '用户名', sort: true},
                {field: 'status', title: '用户状态', templet: (d)=>{
                    if (d.status) {
                        return userStatus[d.status];
                    }
                    return "-";
                }},
                {field: 'createTime', title: '创建时间', sort: true},
                {field: 'updateTime', title: '更新时间', sort: true},
                {field: 'lastLoginTime', title: '上次登录', sort: true},
                {title: '操作', toolbar: '#currentTableBar', align: 'center'}
            ]],
            loading: true,
            url: '../api/auth/queryList',
            page: true,
            limits: [10, 15, 35, 50, 100],
            limit: 10
        });
        table.on('tool(currentTableFilter)', function (obj){
            const data = obj.data;
            const tr = obj.tr;
            if(obj.event === 'editUser'){
                showEditUserDialog(data);
            }else if(obj.event === 'deleteUser'){
                layer.confirm(`确定删除用户【${data.userName}】吗？`, function (){
                    const delInfo = {
                        id: data["id"],
                        status: "4"
                    };
                    $.ajax({
                        url: '../api/auth/updateUserInfo',
                        data: delInfo,
                        method: 'post'
                    }).then(() => {
                        obj.del();
                        layer.closeAll();
                        layer.msg("删除成功");
                    }, () => {
                        layer.msg("操作失败");
                    })
                });
            }
        });
        form.on('submit(add-btn)', data => {
            if($("#submit").hasClass("layui-btn-disabled")){
                return false;
            }
            $("#submit").addClass("layui-btn-disabled");
            //执行搜索重载
            const userInfo = data.field;
            userInfo.userName = $.trim(userInfo.userName);
            userInfo.password = $.trim(userInfo.password);
            $.ajax({
                url: '../api/auth/createUser',
                data: userInfo,
                method: 'post'
            }).then((result) => {
                const code = result.code;
                const msg = result.msg;
                if(code != 200){
                    layer.msg("新增失败，原因：" + msg);
                    $("#submit").removeClass("layui-btn-disabled");
                    return;
                }
                $("#password").val(msg);
                navigator.clipboard.writeText(`为强化数据安全，弹幕查询网站已启用登录验证。\n• 地址: https://livechat.cyf.mom/\n• 用户名: \`${userInfo.userName}\`\n• 初始密码: \`${msg}\`\n登录后可自行修改密码`);
                layer.msg("新增成功，相关信息已复制到剪切板");
                table.reload('userInfo');
                $("#submit").removeClass("layui-btn-disabled");
            }, () => {
                $("#submit").removeClass("layui-btn-disabled");
                layer.msg("新增失败");
            })
            return false;
        });
        function showEditUserDialog(data) {
            showDialog("dialog/editUserInfo.html", {
                title: "修改用户信息",
                success: function(layero){
                    $(layero).find("#id").val(data.id);
                    $(layero).find("#userName").val(data.userName);
                    $(layero).find("#status").val(data.status);
                    form.render();
                },
                btn: ["修改", "关闭"],
                yes: function (){
                    const userInfo = form.val("user-info-form");
                    $.ajax({
                        url: '../api/auth/updateUserInfo',
                        data: userInfo,
                        method: 'post'
                    }).then(() => {
                        layer.closeAll();
                        layer.msg("更新成功");
                        table.reload('userInfo');
                    }, () => {
                        layer.msg("更新失败");
                    })
                }
            })
        }
        initSchemaNav();
    })
</script>
</body>
</html>